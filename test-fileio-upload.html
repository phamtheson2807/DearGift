<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test file.io Upload</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #000;
            color: white;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ff6b9d;
            border-radius: 10px;
            background: rgba(255, 107, 157, 0.1);
        }
        button {
            background: #ff6b9d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #e55a8b;
        }
        input[type="file"] {
            margin: 10px 0;
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid #ff6b9d;
            border-radius: 5px;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            min-height: 50px;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
        audio {
            width: 100%;
            margin: 10px 0;
        }
        .url-link {
            word-break: break-all;
            color: #4CAF50;
            text-decoration: underline;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>üéµ Test file.io Music Upload</h1>
    <p>Test vi·ªác upload nh·∫°c l√™n file.io v√† l·∫•y link t·ª± ƒë·ªông cho DearGift Creator</p>

    <div class="test-section">
        <h2>üì§ Test Upload to file.io</h2>
        <input type="file" id="musicFile" accept="audio/*,video/mp4,video/webm">
        <br>
        <button onclick="testUpload()">Upload & Get Link</button>
        <button onclick="clearResults()">Clear</button>
        
        <div id="uploadResult" class="result">
            <em>Ch·ªçn file nh·∫°c v√† click "Upload & Get Link" ƒë·ªÉ test...</em>
        </div>
        
        <audio id="testAudio" controls style="display: none;"></audio>
    </div>

    <div class="test-section">
        <h2>üîó Test Link Validation</h2>
        <input type="url" id="testUrl" placeholder="Nh·∫≠p URL ƒë·ªÉ test playback" style="width: 70%; padding: 8px; margin: 5px;">
        <button onclick="testPlayback()">Test Playback</button>
        
        <div id="playbackResult" class="result">
            <em>Nh·∫≠p URL v√† click "Test Playback" ƒë·ªÉ test...</em>
        </div>
    </div>

    <div class="test-section">
        <h2>üîÑ Test Alternative Methods</h2>
        <p>N·∫øu file.io b·ªã CORS, test c√°c ph∆∞∆°ng ph√°p kh√°c:</p>
        <button onclick="testLocalBlob()">Test Local Blob URL</button>
        <button onclick="testBase64()">Test Base64 Encoding</button>
        <button onclick="testFileReader()">Test FileReader API</button>
        
        <div id="alternativeResult" class="result">
            <em>Click c√°c n√∫t tr√™n ƒë·ªÉ test ph∆∞∆°ng ph√°p thay th·∫ø...</em>
        </div>
    </div>

    <div class="test-section">
        <h2>‚ÑπÔ∏è Th√¥ng tin file.io & Alternatives</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
                <h3>file.io</h3>
                <ul>
                    <li><strong>Mi·ªÖn ph√≠:</strong> ‚úÖ Ho√†n to√†n mi·ªÖn ph√≠</li>
                    <li><strong>Gi·ªõi h·∫°n:</strong> 100MB per file</li>
                    <li><strong>Th·ªùi gian l∆∞u:</strong> 14 ng√†y</li>
                    <li><strong>CORS:</strong> ‚ö†Ô∏è C√≥ th·ªÉ b·ªã block</li>
                </ul>
            </div>
            <div>
                <h3>Blob URL (Fallback)</h3>
                <ul>
                    <li><strong>Mi·ªÖn ph√≠:</strong> ‚úÖ Ho√†n to√†n mi·ªÖn ph√≠</li>
                    <li><strong>Gi·ªõi h·∫°n:</strong> RAM c·ªßa browser</li>
                    <li><strong>Th·ªùi gian l∆∞u:</strong> Trong session</li>
                    <li><strong>CORS:</strong> ‚úÖ Kh√¥ng v·∫•n ƒë·ªÅ</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let uploadedUrl = null;

        async function testUpload() {
            const fileInput = document.getElementById('musicFile');
            const resultDiv = document.getElementById('uploadResult');
            const audioPlayer = document.getElementById('testAudio');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<span class="error">‚ùå Vui l√≤ng ch·ªçn file nh·∫°c!</span>';
                return;
            }
            
            const file = fileInput.files[0];
            
            // Validate file
            if (!file.type.startsWith('audio/') && !file.type.startsWith('video/')) {
                resultDiv.innerHTML = '<span class="error">‚ùå File kh√¥ng ph·∫£i l√† audio/video!</span>';
                return;
            }
            
            if (file.size > 100 * 1024 * 1024) {
                resultDiv.innerHTML = '<span class="error">‚ùå File qu√° l·ªõn! file.io ch·ªâ h·ªó tr·ª£ t·ªëi ƒëa 100MB.</span>';
                return;
            }
            
            resultDiv.innerHTML = '<span class="info">üì§ ƒêang upload l√™n file.io...</span>';
            
            try {
                // Create FormData
                const formData = new FormData();
                formData.append('file', file);
                
                // Upload to file.io with timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
                
                const response = await fetch('https://file.io/', {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal,
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'Upload failed');
                }
                
                uploadedUrl = result.link;
                
                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Upload th√†nh c√¥ng!</div>
                    <div><strong>File:</strong> ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)</div>
                    <div><strong>Link:</strong> <span class="url-link" onclick="copyToClipboard('${uploadedUrl}')">${uploadedUrl}</span></div>
                    <div><small>Click v√†o link ƒë·ªÉ copy</small></div>
                    <button onclick="testPlayback('${uploadedUrl}')" style="margin-top: 10px;">üéµ Test Playback</button>
                `;
                
            } catch (error) {
                console.error('Upload error:', error);
                
                let errorMessage = '‚ùå Upload th·∫•t b·∫°i: ';
                if (error.name === 'AbortError') {
                    errorMessage += 'Timeout (qu√° 10s)';
                } else if (error.message.includes('CORS')) {
                    errorMessage += 'CORS policy - file.io block request t·ª´ browser. Th·ª≠ Blob URL thay th·∫ø.';
                } else {
                    errorMessage += error.message;
                }
                
                resultDiv.innerHTML = `
                    <div class="error">${errorMessage}</div>
                    <div style="margin-top: 10px;">
                        <button onclick="testLocalBlob()" style="background: #ff9800;">üîÑ Th·ª≠ Blob URL</button>
                        <button onclick="testBase64()" style="background: #2196F3;">üìù Th·ª≠ Base64</button>
                    </div>
                `;
            }
        }

        async function testPlayback(url = null) {
            const testUrl = url || document.getElementById('testUrl').value;
            const resultDiv = document.getElementById('playbackResult');
            const audioPlayer = document.getElementById('testAudio');
            
            if (!testUrl) {
                resultDiv.innerHTML = '<span class="error">‚ùå Vui l√≤ng nh·∫≠p URL!</span>';
                return;
            }
            
            resultDiv.innerHTML = '<span class="info">üîÑ ƒêang test playback...</span>';
            
            try {
                // Test if URL is accessible
                const response = await fetch(testUrl, { method: 'HEAD' });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Try to play audio
                audioPlayer.src = testUrl;
                audioPlayer.style.display = 'block';
                
                audioPlayer.addEventListener('loadstart', function() {
                    resultDiv.innerHTML = '<span class="info">üì• ƒêang t·∫£i audio...</span>';
                }, { once: true });
                
                audioPlayer.addEventListener('canplay', function() {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Audio s·∫µn s√†ng ph√°t!</div>
                        <div><strong>URL:</strong> ${testUrl}</div>
                        <div><small>S·ª≠ d·ª•ng player b√™n d∆∞·ªõi ƒë·ªÉ test</small></div>
                    `;
                }, { once: true });
                
                audioPlayer.addEventListener('error', function(e) {
                    resultDiv.innerHTML = `
                        <div class="error">‚ùå Kh√¥ng th·ªÉ ph√°t audio</div>
                        <div><strong>Error:</strong> ${e.target.error?.message || 'Unknown error'}</div>
                        <div><strong>URL:</strong> ${testUrl}</div>
                    `;
                }, { once: true });
                
                audioPlayer.load();
                
            } catch (error) {
                console.error('Playback test error:', error);
                resultDiv.innerHTML = `<span class="error">‚ùå Test th·∫•t b·∫°i: ${error.message}</span>`;
                audioPlayer.style.display = 'none';
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ ƒê√£ copy link v√†o clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('‚úÖ ƒê√£ copy link v√†o clipboard!');
            });
        }

        function clearResults() {
            document.getElementById('uploadResult').innerHTML = '<em>Ch·ªçn file nh·∫°c v√† click "Upload & Get Link" ƒë·ªÉ test...</em>';
            document.getElementById('playbackResult').innerHTML = '<em>Nh·∫≠p URL v√† click "Test Playback" ƒë·ªÉ test...</em>';
            document.getElementById('alternativeResult').innerHTML = '<em>Click c√°c n√∫t tr√™n ƒë·ªÉ test ph∆∞∆°ng ph√°p thay th·∫ø...</em>';
            document.getElementById('testAudio').style.display = 'none';
            document.getElementById('musicFile').value = '';
            document.getElementById('testUrl').value = '';
            uploadedUrl = null;
        }

        // Alternative methods for when file.io fails
        function testLocalBlob() {
            const fileInput = document.getElementById('musicFile');
            const resultDiv = document.getElementById('alternativeResult');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<span class="error">‚ùå Vui l√≤ng ch·ªçn file nh·∫°c tr∆∞·ªõc!</span>';
                return;
            }
            
            const file = fileInput.files[0];
            resultDiv.innerHTML = '<span class="info">üîÑ ƒêang t·∫°o Blob URL...</span>';
            
            try {
                // Create blob URL
                const blobUrl = URL.createObjectURL(file);
                
                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Blob URL t·∫°o th√†nh c√¥ng!</div>
                    <div><strong>File:</strong> ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)</div>
                    <div><strong>Blob URL:</strong> <span class="url-link" onclick="copyToClipboard('${blobUrl}')">${blobUrl}</span></div>
                    <div><small>‚ö†Ô∏è URL n√†y ch·ªâ ho·∫°t ƒë·ªông trong session hi·ªán t·∫°i</small></div>
                    <button onclick="testPlayback('${blobUrl}')" style="margin-top: 10px;">üéµ Test Playback</button>
                `;
                
            } catch (error) {
                console.error('Blob URL error:', error);
                resultDiv.innerHTML = `<span class="error">‚ùå T·∫°o Blob URL th·∫•t b·∫°i: ${error.message}</span>`;
            }
        }

        function testBase64() {
            const fileInput = document.getElementById('musicFile');
            const resultDiv = document.getElementById('alternativeResult');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<span class="error">‚ùå Vui l√≤ng ch·ªçn file nh·∫°c tr∆∞·ªõc!</span>';
                return;
            }
            
            const file = fileInput.files[0];
            
            if (file.size > 5 * 1024 * 1024) {
                resultDiv.innerHTML = '<span class="error">‚ùå File qu√° l·ªõn cho Base64! Ch·ªâ h·ªó tr·ª£ file d∆∞·ªõi 5MB.</span>';
                return;
            }
            
            resultDiv.innerHTML = '<span class="info">üîÑ ƒêang convert sang Base64...</span>';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Data = e.target.result;
                
                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Base64 t·∫°o th√†nh c√¥ng!</div>
                    <div><strong>File:</strong> ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)</div>
                    <div><strong>Base64 length:</strong> ${base64Data.length} characters</div>
                    <div><small>‚ö†Ô∏è Data l·ªõn, kh√¥ng hi·ªÉn th·ªã to√†n b·ªô</small></div>
                    <button onclick="testPlayback('${base64Data}')" style="margin-top: 10px;">üéµ Test Playback</button>
                `;
            };
            
            reader.onerror = function(error) {
                console.error('FileReader error:', error);
                resultDiv.innerHTML = `<span class="error">‚ùå Convert Base64 th·∫•t b·∫°i</span>`;
            };
            
            reader.readAsDataURL(file);
        }

        function testFileReader() {
            const fileInput = document.getElementById('musicFile');
            const resultDiv = document.getElementById('alternativeResult');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<span class="error">‚ùå Vui l√≤ng ch·ªçn file nh·∫°c tr∆∞·ªõc!</span>';
                return;
            }
            
            const file = fileInput.files[0];
            resultDiv.innerHTML = '<span class="info">üîÑ ƒêang ƒë·ªçc file v·ªõi FileReader...</span>';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const arrayBuffer = e.target.result;
                const blob = new Blob([arrayBuffer], { type: file.type });
                const url = URL.createObjectURL(blob);
                
                resultDiv.innerHTML = `
                    <div class="success">‚úÖ FileReader + Blob th√†nh c√¥ng!</div>
                    <div><strong>File:</strong> ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)</div>
                    <div><strong>ArrayBuffer size:</strong> ${arrayBuffer.byteLength} bytes</div>
                    <div><strong>Blob URL:</strong> <span class="url-link" onclick="copyToClipboard('${url}')">${url}</span></div>
                    <button onclick="testPlayback('${url}')" style="margin-top: 10px;">üéµ Test Playback</button>
                `;
            };
            
            reader.onerror = function(error) {
                console.error('FileReader error:', error);
                resultDiv.innerHTML = `<span class="error">‚ùå FileReader th·∫•t b·∫°i</span>`;
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Show file info when selected
        document.getElementById('musicFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const resultDiv = document.getElementById('uploadResult');
            
            if (file) {
                resultDiv.innerHTML = `
                    <div><strong>File ƒë√£ ch·ªçn:</strong> ${file.name}</div>
                    <div><strong>K√≠ch th∆∞·ªõc:</strong> ${(file.size / 1024 / 1024).toFixed(2)}MB</div>
                    <div><strong>Lo·∫°i:</strong> ${file.type}</div>
                    <div><em>Click "Upload & Get Link" ƒë·ªÉ upload...</em></div>
                `;
            }
        });
    </script>
</body>
</html>
